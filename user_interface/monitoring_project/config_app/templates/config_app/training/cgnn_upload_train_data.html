{% extends 'base.html' %}

{% block title %}Upload CGNN Train Data{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="text-center mb-4">Upload CGNN Train Data</h1>
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="train_array" class="form-label">Train Array:</label>
                    <input type="file" class="form-control" name="train_array" id="train_array" required>
                </div>
                <div class="mb-3">
                    <label for="test_array" class="form-label">Test Array:</label>
                    <input type="file" class="form-control" name="test_array" id="test_array" required>
                </div>
                <div class="mb-3">
                    <label for="anomaly_label_array" class="form-label">Anomaly Label Array:</label>
                    <input type="file" class="form-control" name="anomaly_label_array" id="anomaly_label_array" required>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" name="anomaly_sequence" id="anomaly_sequence">
                    <label for="anomaly_sequence" class="form-check-label">Anomaly Sequence</label>
                </div>
                <div class="mb-3">
                    <label for="dataset" class="form-label">Dataset:</label>
                    <input type="text" class="form-control" name="dataset" id="dataset" required>
                </div>
                <div class="mb-3">
                    <label for="comment" class="form-label">Comment:</label>
                    <textarea class="form-control" name="comment" id="comment"></textarea>
                </div>
                <div class="mb-3">
                    <label for="step_size" class="form-label">Step Size:</label>
                    <input type="number" class="form-control" name="step_size" id="step_size" value="1" required>
                </div>
                <div class="mb-3">
                    <label for="duration" class="form-label">Duration:</label>
                    <input type="number" class="form-control" name="duration" id="duration" value="1" required>
                </div>
                <div class="mb-3">
                    <label for="metricSelect" class="form-label">Select Metric:</label>
                    <div class="input-group">
                        <select id="metricSelect" class="form-select">
                            <option value="">Select a metric</option>
                            {% for key, value in metrics.items %}
                                <option value="{{ key }}">{{ value.info }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-primary" onclick="addMetric()">Add Metric</button>
                    </div>
                </div>
                <div id="selectedMetricsContainer" class="mb-3"></div>
                <input type="hidden" name="selected_metrics" id="selectedMetrics" value="[]">

                <div class="mb-3">
                    <label for="containerInput" class="form-label">Add Container:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="containerInput">
                        <button type="button" class="btn btn-primary" onclick="addContainer()">Add Container</button>
                    </div>
                </div>
                <div id="containersContainer" class="mb-3"></div>
                <input type="hidden" name="containers" id="containers" value="[]">

                <button type="submit" class="btn btn-success w-100">Submit</button>
            </form>
        </div>
    </div>
</div>

<script>
    function addMetric() {
        const metricSelect = document.getElementById('metricSelect');
        const selectedMetric = metricSelect.value;
        const selectedMetricText = metricSelect.options[metricSelect.selectedIndex].text;
        const selectedMetricsContainer = document.getElementById('selectedMetricsContainer');

        if (!selectedMetric) {
            return;
        }

        const metricBox = document.createElement('div');
        metricBox.className = 'metric-box mb-2';
        metricBox.dataset.metric = selectedMetric;
        metricBox.innerHTML = `
            <div class="card">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <span>${selectedMetricText}</span>
                    <div>
                        <button type="button" class="btn btn-sm btn-secondary me-1" onclick="moveUp(this, 'metric-box')">↑</button>
                        <button type="button" class="btn btn-sm btn-secondary me-1" onclick="moveDown(this, 'metric-box')">↓</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeElement(this, 'metric-box')">Remove</button>
                    </div>
                </div>
            </div>
        `;

        selectedMetricsContainer.appendChild(metricBox);
        updateHiddenInput('selectedMetrics', 'metric-box', 'metric');
    }

    function addContainer() {
        const containerInput = document.getElementById('containerInput');
        const containerName = containerInput.value.trim();
        const containersContainer = document.getElementById('containersContainer');

        if (!containerName) {
            return;
        }

        const containerBox = document.createElement('div');
        containerBox.className = 'container-box mb-2';
        containerBox.dataset.container = containerName;
        containerBox.innerHTML = `
            <div class="card">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <span>${containerName}</span>
                    <div>
                        <button type="button" class="btn btn-sm btn-secondary me-1" onclick="moveUp(this, 'container-box')">↑</button>
                        <button type="button" class="btn btn-sm btn-secondary me-1" onclick="moveDown(this, 'container-box')">↓</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeElement(this, 'container-box')">Remove</button>
                    </div>
                </div>
            </div>
        `;

        containersContainer.appendChild(containerBox);
        containerInput.value = '';
        updateHiddenInput('containers', 'container-box', 'container');
    }

    function moveUp(button, className) {
        const box = button.closest(`.${className}`);
        const previousBox = box.previousElementSibling;
        if (previousBox) {
            box.parentNode.insertBefore(box, previousBox);
            updateHiddenInput(className === 'metric-box' ? 'selectedMetrics' : 'containers', className, className === 'metric-box' ? 'metric' : 'container');
        }
    }

    function moveDown(button, className) {
        const box = button.closest(`.${className}`);
        const nextBox = box.nextElementSibling;
        if (nextBox) {
            box.parentNode.insertBefore(nextBox, box);
            updateHiddenInput(className === 'metric-box' ? 'selectedMetrics' : 'containers', className, className === 'metric-box' ? 'metric' : 'container');
        }
    }

    function removeElement(button, className) {
        const box = button.closest(`.${className}`);
        box.parentNode.removeChild(box);
        updateHiddenInput(className === 'metric-box' ? 'selectedMetrics' : 'containers', className, className === 'metric-box' ? 'metric' : 'container');
    }

    function updateHiddenInput(hiddenInputId, boxClassName, dataAttribute) {
        const container = document.getElementById(hiddenInputId).parentNode.querySelector(`#${boxClassName === 'metric-box' ? 'selectedMetricsContainer' : 'containersContainer'}`);
        const boxes = container.getElementsByClassName(boxClassName);
        const values = [];
        for (let box of boxes) {
            values.push(box.dataset[dataAttribute]);
        }
        document.getElementById(hiddenInputId).value = JSON.stringify(values);
    }

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('uploadForm');
        if (form) {
            form.addEventListener('submit', function () {
                showOverlay();
            });
        }
    });
</script>
{% endblock %}
