{% extends "base.html" %}

{% block title %}Monitoring Dashboard{% endblock %}

{% block sidebar %}
<div class="sidebar bg-light text-dark p-4 shadow">
    <h4 class="text-dark mb-4">Tasks</h4>
    <ul id="taskIdList" class="list-unstyled">
    </ul>
</div>
{% endblock %}

{% block content_class %}with-sidebar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center my-4">Monitoring Dashboard</h1>
            <div id="taskDetails" class="task-details mb-4 p-4 bg-light rounded shadow-sm">
            </div>
            <div class="chart-container bg-white p-4 rounded shadow-sm">
                <canvas id="monitoringChart" width="400" height="200"></canvas>
            </div>
            <div id="crcaTaskDetails" class="crca-task-details mt-4 p-4 bg-white rounded shadow-sm">
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fetchResultsUrl = "{% url 'fetch_cgnn_results' %}";
        const fetchCrcaTaskDetailsUrl = "{% url 'fetch_crca_task_details' %}";
        let chartInstance = null;
        let allResults = {};

        async function fetchResults() {
            const response = await fetch(fetchResultsUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        }

        function formatStartTime(startTime) {
            const date = new Date(startTime * 1000);
            return date.toLocaleString();
        }

        function populateSidebar(results) {
            const taskIdList = document.getElementById('taskIdList');
            taskIdList.innerHTML = '';

            const taskIdStartTimes = Object.keys(results).map(taskId => {
                const firstResult = results[taskId].results[0];
                const startTime = firstResult ? firstResult.start_time : null;
                return { taskId, startTime };
            });

            taskIdStartTimes.sort((a, b) => b.startTime - a.startTime);

            taskIdStartTimes.forEach(({ taskId, startTime }) => {
                const listItem = document.createElement('li');
                listItem.classList.add('mb-2');
                const link = document.createElement('a');
                link.href = "#";
                link.textContent = "Session: " + formatStartTime(startTime);
                link.classList.add('text-decoration-none', 'text-dark', 'd-block', 'py-1', 'px-1', 'rounded', 'sidebar-link');
                link.addEventListener('click', () => {
                    displayTaskDetails(results[taskId]);
                    plotData(results[taskId].results);
                });
                listItem.appendChild(link);
                taskIdList.appendChild(listItem);
            });
        }

        function displayTaskDetails(taskData) {
            const taskDetails = document.getElementById('taskDetails');
            const startTimeFormatted = formatStartTime(taskData.start_time);
            const containersFormatted = taskData.containers.join(', ');
            const metricsFormatted = taskData.metrics.join(', ');

            taskDetails.innerHTML = `
                <h3 class="my-3">Task Details</h3>
                <p><strong>Model:</strong> ${taskData.model}</p>
                <p><strong>Start Time:</strong> ${startTimeFormatted}</p>
                <p><strong>Containers:</strong> ${containersFormatted}</p>
                <p><strong>Metrics:</strong> ${metricsFormatted}</p>
            `;

            const crcaTaskIds = Object.values(taskData.results)
                .filter(result => result.percentage > taskData.crca_threshold)
                .map(result => ({ crca_task_id: result.crca_task_id, start_time: result.start_time }));

            if (crcaTaskIds.length > 0) {
                populateCrcaDropdown(crcaTaskIds);
            }
        }

        function populateCrcaDropdown(crcaTaskIds) {
            const crcaTaskDetails = document.getElementById('crcaTaskDetails');
            crcaTaskDetails.innerHTML = `
                <h2>Select CRCA Task ID</h2>
                <select id="crcaTaskDropdown" class="form-select my-3">
                    <option disabled selected>Select CRCA Task ID</option>
                    ${crcaTaskIds.map(task => `<option value="${task.crca_task_id}">${formatStartTime(task.start_time)}</option>`).join('')}
                </select>
                <div id="crcaTaskContent"></div>
            `;

            const dropdown = document.getElementById('crcaTaskDropdown');
            dropdown.addEventListener('change', async () => {
                const selectedTaskId = dropdown.value;
                await fetchAndDisplayCrcaTaskDetails(selectedTaskId);
            });
        }

        async function fetchAndDisplayCrcaTaskDetails(taskId) {
            const response = await fetch(`${fetchCrcaTaskDetailsUrl}?task_id=${taskId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const crcaData = await response.json();
            displayCrcaTaskDetails(crcaData);
        }

        function displayCrcaTaskDetails(crcaData) {
            const crcaTaskContent = document.getElementById('crcaTaskContent');
            crcaTaskContent.innerHTML = `
                <h2>CRCA Task Details</h2>
                <div class="text-center">
                    <h3>Graph Images</h3>
                    ${crcaData.graph_image ? `<img src="data:image/png;base64,${crcaData.graph_image}" alt="Graph Image" class="img-fluid mb-3" />` : ''}
                </div>
                <h3>CSV Data</h3>
                <div class="table-responsive">
                    ${convertCsvToTable(crcaData.ranking)}
                </div>
            `;
        }

        function convertCsvToTable(csvData) {
            const lines = csvData.split('\n');
            const table = document.createElement('table');
            table.classList.add('table', 'table-striped', 'table-bordered');

            lines.forEach((line, index) => {
                const row = table.insertRow();
                const cells = line.split(',');
                cells.forEach(cell => {
                    const cellElement = index === 0 ? row.insertCell('th') : row.insertCell();
                    cellElement.textContent = cell;
                });
            });

            return table.outerHTML;
        }

        function plotData(data) {
            const labels = Object.values(data).map(item => {
                const date = new Date(item.end_time * 1000);
                return date.toLocaleString();
            });
            const values = Object.values(data).map(item => item.percentage);

            const ctx = document.getElementById('monitoringChart').getContext('2d');

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Anomaly Detection Results',
                        data: values,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentage'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'End Time'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#333'
                            }
                        }
                    }
                }
            });
        }

        async function updateDashboard() {
            try {
                allResults = await fetchResults();
                populateSidebar(allResults);
                const firstTaskId = Object.keys(allResults)[0];
                displayTaskDetails(allResults[firstTaskId]);
                plotData(allResults[firstTaskId].results);
            } catch (error) {
                console.error('Error fetching results:', error);
            }
        }

        updateDashboard();
    });
</script>

<style>
.sidebar-link {
    transition: background-color 0.3s ease, color 0.3s ease;
}
.sidebar-link:hover {
    background-color: #f0f0f0 !important;
    color: #000000 !important;
    text-decoration: none !important;
    font-weight: bold !important;
}
.text-center img {
    display: block;
    margin-left: auto;
    margin-right: auto;
}
</style>
{% endblock %}
